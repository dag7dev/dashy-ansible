---
- name: Deploy Dashy App
  hosts: all
  become: true
  roles:
    - geerlingguy.nodejs
  tasks:
    - name: Clone Dashy repository
      git:
        repo: https://github.com/Lissy93/dashy.git
        dest: /home/nephila/dashy  
        
    - name: Install "yarn" node.js package globally.
      community.general.npm:
        name: yarn
        global: true
      
    - name: Install dependencies with yarn
      command: yarn
      args:
        chdir: /home/nephila/dashy  
      
    - name: Build the app with yarn
      command: yarn build
      args:
        chdir: /home/nephila/dash
        
    - name: Open port in the firewall
      ufw:
        rule: allow
        port: "4000"
      
    - name: "Install forever (to run Node.js app)."
      npm: name=forever global=yes state=present
    
    - name: "Check list of Node.js apps running."
      command: forever list
      register: forever_list
      changed_when: false
    
    - name: "Start example Node.js app."
      command: forever start  /home/nephila/dashy/server.js
      when: "forever_list.stdout.find('/path/to/app.js') == -1"
